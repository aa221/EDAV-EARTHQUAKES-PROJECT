# Results

```{r}
library(ggplot2)
library(forcats)
library(janitor)
library('openxlsx')
library(tidyr)
library(stringr)
library(httr)
library(jsonlite)
library(plyr)
library(dplyr)
```

```{r}

## hey we're working here 
pages <- seq(1,2)
us_eq_data = adply(pages, 1,
            function(page_no){
              res <- GET(paste0("https://www.ngdc.noaa.gov/hazel/hazard-service/api/v1/earthquakes?country=USA&page=",
                                page_no))
              data1 <- fromJSON(rawToChar(res$content))
              return(data1$items)
            }
            )
            
```

```{r}
## state and earthquakes table
state_earthquakes <- read.csv("data/earthquakes_by_state.csv")
state_pop <- read.xlsx("data/pop_data.xlsx")
```


```{r}
# The third row has the column names


state_pop <- state_pop %>%
  row_to_names(row_number = 3) %>%
  clean_names()

colnames(state_pop)[1] = 'State'

state_pop <- state_pop %>% 
  slice(6:(nrow(state_pop)-5) ) %>% 
  mutate(State = substring(State, 2)) %>% 
  select(-2) %>% 
  mutate(across(.cols = 2:ncol(.), .fns = as.numeric)) %>% 
  tibble() 


```


```{r}
state_pop
```





```{r}
(fivenum(state_earthquakes$YEAR))
```

```{r}
# Pivot the table so we have one row per year and state

population_per_state <- state_pop %>%
  pivot_longer(cols = starts_with("x"),
               names_to = "year",
               values_to = "population") %>%
  arrange(State, year)

# Display the updated data frame
population_per_state
```

```{r}

# Remove the 'x' and '.'
population_per_state <- population_per_state %>%
  mutate(year = as.numeric(str_remove(year, "x")))

population_per_state
```

```{r}
state_earthquakes_selected <- state_earthquakes %>%
  select(NAME,MAGNITUDE)
```




```{r,fig.width=10, fig.height=5}
# Group by state, calculate the average magnitude across all years


# Assuming your data frame is named 'your_data'

# Drop rows with NA values
state_earthquakes_selected_cleaned <- na.omit(state_earthquakes_selected)

# Select one row per state, grouping by and getting the average
one_per_state  <- state_earthquakes_selected_cleaned %>% mutate(col_a = 1) %>% select(state = NAME, magnitude=MAGNITUDE) %>% group_by(state) %>% summarise(magnitude=mean(magnitude))



ggplot(one_per_state, aes(x = magnitude)) +
  geom_bar(stat = "identity", aes(y=fct_reorder(state, magnitude)),fill = "skyblue") +
  labs(title = "Average Magnitude Per State for 1638-1985", x =  "Average Magnitude", y = "State") +
  theme_minimal()

```
As we can see, the average magnitude of earth quakes is highest in Idaho This is interesting because it seems as though the highest magnitutde earthquakes occur on the west coast. Nevada, Utah, Washington are  also all on the west coast, which brings up the argument that states on the west coast are more impacted by Earthquakes, in terms of how strong they are. There could be an argument that these states have a higher population than others so we will verify that soon.

```{r}
p1 <- state_earthquakes %>% mutate(DECADE_START = YEAR - YEAR %% 10) %>% 
  drop_na(MAGNITUDE) %>% 
  group_by(DECADE_START, YEAR, MONTH, DAY, STATE) %>% 
  summarise(MAGNITUDE=mean(MAGNITUDE)) %>% 
  ungroup() %>% 
  mutate(YEAR = as.factor(YEAR), DECADE_START = as.factor(DECADE_START)) %>% 
  ggplot() + 
  geom_boxplot(aes(y=MAGNITUDE, x=DECADE_START), varwidth = TRUE, outlier.size = 0.1, fill="red", alpha=0.5) + 
  theme_linedraw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

p2 <- state_earthquakes %>% mutate(DECADE_START = YEAR - YEAR %% 10) %>%
    drop_na(MAGNITUDE) %>% 
    group_by(YEAR, MONTH, DAY, NAME) %>% 
    summarise(MAGNITUDE=mean(MAGNITUDE)) %>% 
    ungroup() %>% 
    mutate(YEAR = as.factor(YEAR)) %>% 
    ggplot() + 
    geom_boxplot(aes(y=MAGNITUDE, x=reorder(NAME, -MAGNITUDE, mean)), varwidth = TRUE, outlier.size = 0.1, fill="red", alpha=0.5) + 
    theme_linedraw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

par(mfrow=c(1,2))
p1
p2
```



```{r}
## use the population from the most recent year
newest_year_pop <- population_per_state %>% 
  filter(year == max(year)) %>%
  select(-year)  # Drop the 'year' column




newest_year_pop


```

```{r}
library(dplyr)


# Perform left join for population and state. 
population_state <- left_join(newest_year_pop, state_earthquakes_selected_cleaned, by = c("State" = "NAME"))
population_state
```




```{r}
## Cleaning the table

counts_and_average_mag <- population_state %>%
  group_by(State) %>%
  summarise(Count = n(), Average_Magnitude = mean(MAGNITUDE, na.rm = TRUE))



# counts_and_average_mag <- counts_and_average_mag[-1, ]

## remove rows with numbers
rows_with_numbers <- grep("\\d", counts_and_average_mag$State)

# Remove rows with numbers
counts_and_average_mag <- counts_and_average_mag[-rows_with_numbers, ]

# Identify rows with ":" in the "State" column
rows_with_colon <- grepl(":", counts_and_average_mag$State)

# Remove rows with ":"
counts_and_average_mag <- counts_and_average_mag[!rows_with_colon, ]
counts_and_average_mag


```





```{r,fig.width=10, fig.height=8}

# Create a horizontal bar chart

library(forcats)
# Order the data by frequency in descending order


# Set wider figure dimensions
options(repr.plot.width = 10, repr.plot.height = 6)



ggplot(counts_and_average_mag, aes(x = Count)) +
  geom_bar(stat = "identity", aes(y=fct_reorder(State, Count)),fill = "skyblue") +
  labs(title = "Earthquake Count Per State for  1638-1985", x = "Earthquake Count", y = "State") +
  theme_minimal()
```
As we can see, California has the most number of Earthquake's, next is Washington, then Nevada. As a result the argument regarding western vs eastern regions is still very relevant to this variable. Despite this it is less relevant as New York and Illinois are up there. These are highly populated areas and thus we will see the correlation between population and earthquake count below and average mag.






```{r}



counts_pop_ <- population_state %>%
  group_by(State) %>%
  summarise(Count = n(), Average_Magnitude = mean(MAGNITUDE, na.rm = TRUE),the_population = mean(population, na.rm = TRUE))


counts_pop_ <- counts_pop_[-1, ]

## remove rows with numbers
rows_with_numbers <- grep("\\d", counts_pop_$State)

# Remove rows with numbers
counts_pop_ <- counts_pop_[-rows_with_numbers, ]

# Identify rows with ":" in the "State" column
rows_with_colon <- grepl(":", counts_pop_$State)

# Remove rows with ":"
counts_pop_ <- counts_pop_[!rows_with_colon, ]


counts_pop_$Count <- round(log(counts_pop_$Count))
counts_pop_$the_population <- log(counts_pop_$the_population) ## took log so we can see it 
counts_pop_
```




```{r,fig.width=10, fig.height=5}




# counts_pop_ <- na.omit(counts_pop_)
# 
# # Create bins for Average_Magnitude
# counts_pop_$bins <- cut(counts_pop_$Average_Magnitude, breaks = c(0, 4, 11), labels = c("0-4", "5-11"))
# 
# # Scatter plot with facets
# ggplot(counts_pop_, aes(x = the_population, y = Count)) +
#   geom_smooth(method = "lm", se = FALSE, col = "blue") +  # Add a line of best fit
# 
#   geom_point() +
#   facet_wrap(~ bins, scales = "free") +
#   labs(title = "Scatter Plot of Current Population vs Frequency of Earthquakes with Binned Average Magnitude for 1638-1985", 
#        x = "Population (LOG)", y = "Frequency of Earthquake (LOG)")

```

There is a Slight positive correlation between states with a higher population and the frequency of which they have earthquakes. This is true for both high and low magnitutde earthquakes. This result, furthermore, motivates the need for safety measures against earthquakes across populus areas. If they do not, then there can be severe consequences for areas that are dense, in the form of lives lost.  
